<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard WA & Drive</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center text-blue-600">
                        <i class="material-icons text-3xl mr-2">chat</i>
                        <span class="font-bold text-xl tracking-tight">WA & Drive Dash</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Connection Status Badge -->
                    <div id="connectionStatus" class="flex items-center px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-sm font-medium border border-slate-200 transition-colors duration-300">
                        <span class="w-2 h-2 rounded-full bg-slate-400 mr-2 animate-pulse"></span>
                        Checking...
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-10">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- Sidebar / Menu (Simple List for now) -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden sticky top-24">
                    <div class="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700">
                        Menu Aplikasi
                    </div>
                    <nav class="p-2 space-y-1">
                        <a href="#" class="flex items-center px-4 py-3 bg-blue-50 text-blue-700 rounded-lg font-medium transition-colors">
                            <i class="material-icons text-sm mr-3">dashboard</i>
                            Dashboard Utama
                        </a>
                        <!-- Placeholder menu items -->
                        <a href="/js.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 rounded-lg transition-colors">
                    
                            <i class="material-icons text-sm mr-3 text-slate-400">settings</i>
                            Jadwal sidang
                        </a>
                    </nav>
                    <div class="p-4 border-t border-slate-100 text-xs text-slate-400 text-center">
                        &copy; 2024 M Asran
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="lg:col-span-9 grid grid-cols-1 gap-8">
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                    <!-- Left Column: Send Message -->
                    <div class="md:col-span-5">
                        <div class="bg-white rounded-xl shadow-lg shadow-slate-200/50 border border-slate-100 overflow-hidden h-full">
                            <div class="bg-slate-50/80 backdrop-blur-sm px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                                <h3 class="font-bold text-slate-700 flex items-center">
                                    <i class="fab fa-whatsapp text-green-500 mr-2 text-lg"></i> Kirim Pesan
                                </h3>
                            </div>
                            <div class="p-6">
                                <form id="kirimPesanForm" class="space-y-5">
                                    <div>
                                        <label for="penerima" class="block text-sm font-semibold text-slate-600 mb-2">Penerima (Grup)</label>
                                        <div class="relative">
                                            <select id="penerima" required class="w-full pl-3 pr-10 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500/20 focus:border-green-500 transition-all appearance-none cursor-pointer">
                                                <option value="">Memuat grup...</option>
                                            </select>
                                            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                                                <i class="fas fa-chevron-down text-xs"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="message" class="block text-sm font-semibold text-slate-600 mb-2">Isi Pesan</label>
                                        <textarea id="message" rows="5" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500/20 focus:border-green-500 transition-all resize-none" placeholder="Tulis pesan Anda di sini..."></textarea>
                                    </div>

                                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2">
                                        <i class="fas fa-paper-plane text-sm"></i> Kirim Sekarang
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Google Drive Info -->
                    <div class="md:col-span-7">
                        <div class="bg-white rounded-xl shadow-lg shadow-slate-200/50 border border-slate-100 overflow-hidden flex flex-col h-full">
                            <div class="bg-slate-50/80 backdrop-blur-sm px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                                <h3 class="font-bold text-slate-700 flex items-center">
                                    <i class="fab fa-google-drive text-blue-500 mr-2 text-lg"></i> Google Drive Hari Ini
                                </h3>
                                <!-- Storage Info Small -->
                                <div id="storageBadge" class="hidden text-xs bg-white border border-slate-200 px-2 py-1 rounded text-slate-500">
                                    Loading...
                                </div>
                            </div>

                            <!-- Storage Progress Bar -->
                            <div class="px-6 pt-6 pb-2">
                                <div class="flex justify-between text-xs font-medium text-slate-500 mb-1">
                                    <span>Penyimpanan</span>
                                    <span id="storageText">Memuat info...</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                    <div id="storageProgress" class="bg-blue-500 h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- File List -->
                            <div id="gdriveData" class="p-6 space-y-3 overflow-y-auto max-h-[500px] flex-grow">
                                <!-- Loader -->
                                <div class="flex justify-center py-10">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Configuration
        const userId = "patrolwaa1";
        const API_WA = "https://wa-api.pnblk.my.id";
        const API_DRIVE = "https://gdrivetoday.vercel.app/gdrive";

        // DOM Elements
        const els = {
            connectionStatus: document.getElementById('connectionStatus'),
            storageText: document.getElementById('storageText'),
            storageBadge: document.getElementById('storageBadge'),
            storageProgress: document.getElementById('storageProgress'),
            penerimaSelect: document.getElementById('penerima'),
            gdriveContainer: document.getElementById('gdriveData'),
            messageForm: document.getElementById('kirimPesanForm'),
            messageInput: document.getElementById('message')
        };

        // --- Helper Functions ---
        
        const updateStatusBadge = (status) => {
            const isConnected = status === 'connected';
            els.connectionStatus.className = `flex items-center px-3 py-1 rounded-full text-sm font-medium border transition-colors duration-300 ${
                isConnected 
                ? 'bg-green-100 text-green-700 border-green-200' 
                : 'bg-red-100 text-red-700 border-red-200'
            }`;
            els.connectionStatus.innerHTML = `
                <span class="w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'} mr-2 ${isConnected ? '' : 'animate-pulse'}"></span>
                ${isConnected ? 'Terhubung' : 'Terputus'}
            `;
        };

        // --- API Fetching Functions ---

        // 1. Fetch Storage Info
        async function fetchStorageInfo() {
            try {
                const res = await fetch(`${API_DRIVE}/info`);
                const data = await res.json();
                
                const total = parseFloat(data.totalStorageGB);
                const used = parseFloat(data.usedStorageGB);
                const percent = ((used / total) * 100).toFixed(1);

                els.storageText.textContent = `${used} GB terpakai dari ${total} GB`;
                els.storageBadge.textContent = `${percent}% Penuh`;
                els.storageBadge.classList.remove('hidden');
                els.storageProgress.style.width = `${percent}%`;
                
                // Warna progress bar berubah jika penuh
                if(percent > 90) els.storageProgress.classList.replace('bg-blue-500', 'bg-red-500');
                else els.storageProgress.classList.add('bg-blue-500');

            } catch (err) {
                console.error("Storage Error:", err);
                els.storageText.textContent = "Gagal memuat info penyimpanan";
            }
        }

        // 2. Fetch WA Groups
        async function fetchGroups() {
            try {
                const res = await fetch(`${API_WA}/groups/${userId}`);
                const groups = await res.json();
                
                els.penerimaSelect.innerHTML = '<option value="">-- Pilih Grup Tujuan --</option>';
                groups.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    els.penerimaSelect.appendChild(opt);
                });
            } catch (err) {
                console.error("Group Error:", err);
                els.penerimaSelect.innerHTML = '<option value="">Gagal memuat grup</option>';
            }
        }

        // 3. Fetch Connection Status
        async function fetchStatus() {
            try {
                const res = await fetch(`${API_WA}/status/${userId}`);
                const data = await res.json();
                updateStatusBadge(data.status);
            } catch (err) {
                updateStatusBadge('error');
            }
        }

        // 4. Fetch Google Drive Folders
        async function fetchGDriveData() {
            try {
                const res = await fetch(API_DRIVE);
                const items = await res.json();
                
                els.gdriveContainer.innerHTML = '';
                
                if(items.length === 0) {
                    els.gdriveContainer.innerHTML = `
                        <div class="text-center py-8 text-slate-400">
                            <i class="far fa-folder-open text-3xl mb-2"></i>
                            <p class="text-sm">Tidak ada folder hari ini.</p>
                        </div>`;
                    return;
                }

                items.forEach((item, index) => {
                    const link = `https://drive.google.com/drive/folders/${item.id}`;
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow fade-in';
                    card.style.animationDelay = `${index * 100}ms`;
                    
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center">
                                <div class="bg-blue-100 p-2 rounded-lg text-blue-600 mr-3">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold text-slate-800 line-clamp-1" title="${item.name}">${item.name}</h4>
                                    <span class="text-xs text-slate-400">Google Drive Folder</span>
                                </div>
                            </div>
                            <a href="${link}" target="_blank" class="text-slate-400 hover:text-blue-600 transition-colors">
                                <i class="fas fa-external-link-alt text-sm"></i>
                            </a>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="handleAction('send', '${item.name}', '${link}')" 
                                class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs font-semibold py-2 rounded transition-colors">
                                <i class="fab fa-whatsapp mr-1"></i> Kirim ke WA
                            </button>
                            <button onclick="handleAction('copy', '${item.name}', '${link}')" 
                                class="flex-1 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-semibold py-2 rounded transition-colors">
                                <i class="far fa-copy mr-1"></i> Salin
                            </button>
                        </div>
                    `;
                    els.gdriveContainer.appendChild(card);
                });

            } catch (err) {
                console.error("Drive Data Error:", err);
                els.gdriveContainer.innerHTML = `
                    <div class="text-center py-8 text-red-400 bg-red-50 rounded-lg">
                        <p class="text-sm font-medium">Gagal memuat data Drive.</p>
                        <button onclick="fetchGDriveData()" class="mt-2 text-xs underline hover:text-red-600">Coba Lagi</button>
                    </div>`;
            }
        }

        // --- Interaction Handlers ---

        window.handleAction = (action, name, link) => {
            const text = `*${name}*\n${link}`;
            
            if (action === 'copy') {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        });
                        Toast.fire({ icon: 'success', title: 'Berhasil disalin!' });
                    })
                    .catch(() => Swal.fire('Oops', 'Gagal menyalin teks', 'error'));
            } else if (action === 'send') {
                // Populate textarea
                els.messageInput.value = text;
                // Smooth scroll to form (mobile friendly)
                els.messageForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Focus textarea
                els.messageInput.focus();
                // Optional flash effect
                els.messageInput.classList.add('ring-2', 'ring-green-500');
                setTimeout(() => els.messageInput.classList.remove('ring-2', 'ring-green-500'), 1000);
            }
        };

        // Handle Form Submit
        els.messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const to = els.penerimaSelect.value;
            const message = els.messageInput.value;
            const submitBtn = els.messageForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;

            if (!to || !message.trim()) {
                Swal.fire({ icon: 'warning', title: 'Data Belum Lengkap', text: 'Silakan pilih grup penerima dan isi pesan.' });
                return;
            }

            // Loading State
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';

            try {
                const res = await fetch(`${API_WA}/send-text`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, to, message, typing: true })
                });
                const result = await res.json();

                Swal.fire({ icon: 'success', title: 'Terkirim!', text: 'Pesan berhasil dikirim ke grup.', timer: 2000, showConfirmButton: false });
                els.messageInput.value = ''; // Clear message ONLY on success

            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Gagal', text: 'Terjadi kesalahan saat mengirim pesan.' });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            fetchGroups();
            fetchStorageInfo();
            fetchGDriveData();

            // Polling status setiap 10 detik
            setInterval(fetchStatus, 10000);
        });

    </script>
</body>
</html>
